<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Collecting Logs for Teleport on AKS | Azure Container Registry</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="">
    
    <link rel="preload" href="/acr/assets/css/0.styles.cbc79662.css" as="style"><link rel="preload" href="/acr/assets/js/app.59451b7a.js" as="script"><link rel="preload" href="/acr/assets/js/2.8ad312e5.js" as="script"><link rel="preload" href="/acr/assets/js/53.5bb962cc.js" as="script"><link rel="prefetch" href="/acr/assets/js/10.b3260419.js"><link rel="prefetch" href="/acr/assets/js/11.cd3d0648.js"><link rel="prefetch" href="/acr/assets/js/12.3e70c35d.js"><link rel="prefetch" href="/acr/assets/js/13.3fc376a3.js"><link rel="prefetch" href="/acr/assets/js/14.2fdcc843.js"><link rel="prefetch" href="/acr/assets/js/15.0583148f.js"><link rel="prefetch" href="/acr/assets/js/16.bf52a417.js"><link rel="prefetch" href="/acr/assets/js/17.97005288.js"><link rel="prefetch" href="/acr/assets/js/18.0ff46afe.js"><link rel="prefetch" href="/acr/assets/js/19.a8e82f29.js"><link rel="prefetch" href="/acr/assets/js/20.cac25d08.js"><link rel="prefetch" href="/acr/assets/js/21.4a36c978.js"><link rel="prefetch" href="/acr/assets/js/22.a2d5b27f.js"><link rel="prefetch" href="/acr/assets/js/23.eff701ef.js"><link rel="prefetch" href="/acr/assets/js/24.66953223.js"><link rel="prefetch" href="/acr/assets/js/25.2ab6f79a.js"><link rel="prefetch" href="/acr/assets/js/26.61787688.js"><link rel="prefetch" href="/acr/assets/js/27.cff52547.js"><link rel="prefetch" href="/acr/assets/js/28.577ff223.js"><link rel="prefetch" href="/acr/assets/js/29.d52f471a.js"><link rel="prefetch" href="/acr/assets/js/3.9247e042.js"><link rel="prefetch" href="/acr/assets/js/30.5eca027b.js"><link rel="prefetch" href="/acr/assets/js/31.0ada84f0.js"><link rel="prefetch" href="/acr/assets/js/32.ae1fa3a1.js"><link rel="prefetch" href="/acr/assets/js/33.f5185b7a.js"><link rel="prefetch" href="/acr/assets/js/34.db1588ba.js"><link rel="prefetch" href="/acr/assets/js/35.2f8c2333.js"><link rel="prefetch" href="/acr/assets/js/36.24ab6092.js"><link rel="prefetch" href="/acr/assets/js/37.587ba82e.js"><link rel="prefetch" href="/acr/assets/js/38.e2260650.js"><link rel="prefetch" href="/acr/assets/js/39.5fad5db8.js"><link rel="prefetch" href="/acr/assets/js/4.f06fcb98.js"><link rel="prefetch" href="/acr/assets/js/40.dc9c34d2.js"><link rel="prefetch" href="/acr/assets/js/41.1dea556f.js"><link rel="prefetch" href="/acr/assets/js/42.e36c0fbb.js"><link rel="prefetch" href="/acr/assets/js/43.6eee3fdf.js"><link rel="prefetch" href="/acr/assets/js/44.3566edd6.js"><link rel="prefetch" href="/acr/assets/js/45.ca93a9bf.js"><link rel="prefetch" href="/acr/assets/js/46.26768fec.js"><link rel="prefetch" href="/acr/assets/js/47.f01c163e.js"><link rel="prefetch" href="/acr/assets/js/48.6784a2f3.js"><link rel="prefetch" href="/acr/assets/js/49.27218d4a.js"><link rel="prefetch" href="/acr/assets/js/5.32ab997c.js"><link rel="prefetch" href="/acr/assets/js/50.613e9bc2.js"><link rel="prefetch" href="/acr/assets/js/51.ff8073b0.js"><link rel="prefetch" href="/acr/assets/js/52.9a1d4763.js"><link rel="prefetch" href="/acr/assets/js/54.47085368.js"><link rel="prefetch" href="/acr/assets/js/6.7677f88d.js"><link rel="prefetch" href="/acr/assets/js/7.c34a52d4.js"><link rel="prefetch" href="/acr/assets/js/8.4edfa6e9.js"><link rel="prefetch" href="/acr/assets/js/9.e310ec2b.js">
    <link rel="stylesheet" href="/acr/assets/css/0.styles.cbc79662.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/acr/" class="home-link router-link-active"><img src="/acr/files/acr.svg" alt="Azure Container Registry" class="logo"> <span class="site-name can-hide">Azure Container Registry</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"> <a href="https://github.com/azure/acr" target="_blank" rel="noopener noreferrer" class="repo-link">
    Star this Repo
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav>  <ul class="sidebar-links"><li><a href="/acr/" aria-current="page" class="sidebar-link">Overview</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/acr/#overview" class="sidebar-link">Overview</a></li><li class="sidebar-sub-header"><a href="/acr/#blog-posts" class="sidebar-link">Blog posts</a></li><li class="sidebar-sub-header"><a href="/acr/#links" class="sidebar-link">Links</a></li></ul></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Teleport</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Tasks</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Authentication</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Integration</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="collecting-logs-for-teleport-on-aks"><a href="#collecting-logs-for-teleport-on-aks" class="header-anchor">#</a> Collecting Logs for Teleport on AKS</h1> <p>This guide goes over how to collect logs for the teleportd daemon running in an AKS cluster. The steps in this guide have to be carried out by customers in order to collect log information for debugging purposes.</p> <h2 id="teleportd-logs"><a href="#teleportd-logs" class="header-anchor">#</a> Teleportd logs</h2> <p>We can get teleportd logs from each node independently to verify that a teleport enabled image succesfully teleported. Because Teleportd is run as a daemon in the node, its logs are only available from journald in a node. To get these a user can either connect to their node which ran the specific pod being debugged (using ssh or lens) and run <code>journalctl -n all -u teleportd</code>. Alternatively you can collect logs by creating sidecar container on the corresponding nodes like we do. The sidecar mounts the filesystem of the nodepool and uses this to obtain journald logs. These are created using the following configuration:</p> <div class="language-yaml line-numbers-mode"><pre class="language-yaml"><code><span class="token key atrule">apiVersion</span><span class="token punctuation">:</span> v1
<span class="token key atrule">kind</span><span class="token punctuation">:</span> Pod
<span class="token key atrule">metadata</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> teleport<span class="token punctuation">-</span>logs
<span class="token key atrule">spec</span><span class="token punctuation">:</span>
  <span class="token key atrule">containers</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> log<span class="token punctuation">-</span>reader
    <span class="token key atrule">image</span><span class="token punctuation">:</span> busybox
    <span class="token key atrule">args</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>/bin/sh<span class="token punctuation">,</span> <span class="token punctuation">-</span>c<span class="token punctuation">,</span> <span class="token string">'/bin/journalctl -n all -u teleportd -f'</span><span class="token punctuation">]</span>
    <span class="token key atrule">volumeMounts</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
      <span class="token key atrule">mountPath</span><span class="token punctuation">:</span> /
<span class="token comment"># Add if customer needs to specify node</span>
<span class="token comment">#   nodeSelector:</span>
<span class="token comment">#     teleport: &quot;true&quot; </span>
  <span class="token key atrule">volumes</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> rootfs
    <span class="token key atrule">hostPath</span><span class="token punctuation">:</span>
      <span class="token key atrule">path</span><span class="token punctuation">:</span> /
      <span class="token key atrule">type</span><span class="token punctuation">:</span> Directory
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br></div></div><p>You can run a pod with the above configuration (make sure to edit the nodeSelector field to set the log collection to the specific node that needs its instance of teleportd to be debugged) and then get the logs from it by calling:
<code>kubectl logs teleport-logs &gt; ./teleport-daemon.log</code></p> <h2 id="other-options"><a href="#other-options" class="header-anchor">#</a> Other options</h2> <h3 id="kubernetes-events-aside"><a href="#kubernetes-events-aside" class="header-anchor">#</a> Kubernetes Events (Aside)</h3> <p>If the affected pod was just ran (events have a short timespan) you can use the following to gather some extra information and even confirm the image teleported:</p> <p>For event collection we are looking at two methods:</p> <ul><li><p>Running <code>kubectl describe pod &lt;your pod name&gt;</code>
Teleportd events try to associate with the pod that first pulled a specific image within a node, nonetheless this can fail, in such a scenario events are not associated with a node but are still reported as general events and will still be visible when running kubectl get events. If everything goes rights the output of this command will include the teleport events, otherwise:</p></li> <li><p>Running <code>kubectl get events</code>
In cases when teleportd fails to associate events with a pod or when multiple pods experienced issues, check all the kubectl get events, they are all sourced from the teleportd client and are marked as such, some will have the image and tag that was teleport or if it failed to teleport.</p></li></ul> <p>Events include overall failure information for teleportd but do not currently give information on individual layer failures. If an image took too long to teleport for example and the events still indicate success there could be individual layer mount failures, refer to the logs in that scenario.</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/azure/acr/edit/master/docs/teleport/collecting-teleportd-logs-aks.md" target="_blank" rel="noopener noreferrer">Edit this page on GitHub</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/acr/assets/js/app.59451b7a.js" defer></script><script src="/acr/assets/js/2.8ad312e5.js" defer></script><script src="/acr/assets/js/53.5bb962cc.js" defer></script>
  </body>
</html>
